@{
    ViewBag.Title = "Khuyến mãi";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@using ShoseShop.ViewModel
@model List<SanphamViewModel>

<style>
   
    .product-images img {
        max-width: 50px;
        max-height: 50px;
        margin-right: 10px;
    }

        .product-images img:hover {
            transform: scale(1.1);
            cursor: pointer;
        }

    .product-details {
        opacity: 1;
        transition: opacity 0.8s ease-in;
    }

        .product-details.lost {
            display: none;
            opacity: 0;
        }

    .product-images.hidden {
        display: none;
    }

    .square-box {
        width: 100%;
        padding-top: 100%;
        position: relative;
        background-color: #FF8E31;
        text-align: center;
        margin: 10px 0px;
        border-radius: 3px;
    }

    .countdown-number {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 18px;
        font-weight: bold;
        color: #FFFFFF;
    }

    .countdown-label {
        position: absolute;
        bottom: 10px;
        left: 50%;
        transform: translate(-50%, 50%);
        font-size: 12px;
        font-weight: bold;
        color: #FFFFFF;
    }
</style>

@section Script{
    <script>
        // Lấy dữ liệu từ ViewBag một cách an toàn
        var maMau1 = @Html.Raw(Json.Encode(ViewBag.maMau1 ?? ""));
        var phantramgiam1 = @Html.Raw(Json.Encode(ViewBag.phantramgiam ?? -1));
        var searchString1 = @Html.Raw(Json.Encode(ViewBag.searchString1 ?? ""));
        var sortGia1 = @Html.Raw(Json.Encode(ViewBag.sortGia1 ?? 0));
        var minPrice1 = @Html.Raw(Json.Encode(ViewBag.minPrice1 ?? 0));
        var maxPrice1 = @Html.Raw(Json.Encode(ViewBag.maxPrice1 ?? 10000000));

        $(document).ready(function () {

            $('#sortGia').change(function () {
                var selectedValue = $(this).val();
                if (selectedValue) {
                    sortGia1 = selectedValue;
                    getToController();
                }
            });

            $('.pixel-radio.mauInput').click(function () {
                var selectedValue = $(this).attr('value');
                var isSelected = $(this).hasClass('selected');

                if (isSelected) {
                    $(this).css({ 'border': 'none' });
                    maMau1 = '';
                    $(this).removeClass('selected');
                } else {
                    $('.pixel-radio.mauInput').css({ 'border': 'none' });
                    $('.pixel-radio.mauInput').removeClass('selected');
                    $(this).css({ 'border': '5px solid #FFBA00', 'box-sizing': 'border-box' });
                    maMau1 = selectedValue;
                    $(this).addClass('selected');
                }
                getToController();
            });

            $('#kmToggle').css({ display: 'none' });
            $('#search_inputKm').change(function () {
                var inputValue = $(this).val();
                if (inputValue) {
                    searchString1 = inputValue;
                    $('#search_input').val(searchString1);
                    getToController();
                }
            });

            var priceRange = document.getElementById("price-range2");
            if (priceRange) { // Kiểm tra xem element có tồn tại không
                var lowerValue = document.getElementById("lower-value2");
                var upperValue = document.getElementById("upper-value2");

                var minPrice = 0;
                var maxPrice = 10000000;
                var lowerBound = 0;
                var upperBound = 10000000;

                lowerValue.textContent = formatPrice(lowerBound);
                upperValue.textContent = formatPrice(upperBound);

                noUiSlider.create(priceRange, {
                    start: [lowerBound, upperBound],
                    connect: true,
                    range: { 'min': minPrice, 'max': maxPrice },
                    step: 500000,
                });

                priceRange.noUiSlider.on('update', function (values, handle) {
                    var value = values[handle];
                    if (handle == 0) {
                        lowerValue.innerText = formatPrice(Math.round(value));
                    } else {
                        upperValue.innerText = formatPrice(Math.round(value));
                    }
                    minPrice1 = values[0];
                    maxPrice1 = values[1];
                    getToController();
                });
            }

            function formatPrice(price) {
                return price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
            }

            function getToController() {
                $.ajax({
                    url: '@Url.Action("FindSaleProduct", "KhuyenMai")',
                    type: 'GET',
                    data: {
                        searchStringKm: searchString1,
                        maMau: maMau1,
                        sortGia: sortGia1,
                        minPrice: minPrice1,
                        maxPrice: maxPrice1,
                        phantramgiam: phantramgiam1
                    },
                    success: function (response) {
                        $('#partialSanPhamKm').html(response);
                    },
                    error: function() {
                        console.error("Lỗi khi lọc sản phẩm khuyến mãi.");
                    }
                });
            }
        });

        function showProductDetails(element) {
            var productDetails = element.querySelector('.product-details');
            productDetails.classList.toggle('lost');
            var productImages = element.querySelector('.product-images');
            productImages.classList.toggle('hidden');
        }

        // Countdown Timer
        var formattedString = @Html.Raw(Json.Encode(ViewBag.Ngaykt != null ? ((DateTime)ViewBag.Ngaykt).ToString("yyyy-MM-dd HH:mm:ss") : ""));
        if (formattedString !== "") {
            var countDownDate = new Date(formattedString).getTime();
            var x = setInterval(function () {
                var now = new Date().getTime();
                var distance = countDownDate - now;

                if (distance < 0) {
                    clearInterval(x);
                    document.getElementById("countdown_container").innerHTML = "<h4 class='text-center text-danger'>ĐÃ HẾT HẠN</h4>";
                    return;
                }

                var days = Math.floor(distance / (1000 * 60 * 60 * 24));
                var hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                var minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                var seconds = Math.floor((distance % (1000 * 60)) / 1000);

                document.getElementById("days").innerText = days;
                document.getElementById("hours").innerText = hours;
                document.getElementById("minutes").innerText = minutes;
                document.getElementById("seconds").innerText = seconds;
            }, 1000);
        }
    </script>
}

@section searchProductSales{
    @using (Html.BeginForm(null, null, FormMethod.Get, new { @class = "d-flex justify-content-between", id = "searchFormKm" }))
    {
        <input type="text" name="searchStringKm" class="form-control" id="search_inputKm" placeholder="Tìm kiếm sản phẩm khuyến mãi">
        <button type="submit" class="btn"></button>
        <span class="lnr lnr-cross" id="close_search" title="Close Search"></span>
    }
}

<section class="banner-area organic-breadcrumb mb-3">
    <div class="container">
        <div class="breadcrumb-banner d-flex flex-wrap align-items-center justify-content-end">
            <div class="col-first">
                <h1>Khuyến mãi</h1>
                <nav class="d-flex align-items-center">
                    <a href="@Url.Action("Index", "Home")">Trang chủ<span class="lnr lnr-arrow-right"></span></a>
                    <a href="@Url.Action("SaleIndex", "KhuyenMai", new { phantramgiam = -1 })">Khuyến mãi</a>
                </nav>
            </div>
        </div>
    </div>
</section>

<div class="container">
    <h2 class="text-center">Siêu Khuyến mại</h2>
    <div class="row justify-content-md-center" id="countdown_container">
        <div class="col-sm-1"><div class="square-box"><p id="days" class="countdown-number">00</p><span class="countdown-label">Ngày</span></div></div>
        <div class="col-sm-1"><div class="square-box"><p id="hours" class="countdown-number">00</p><span class="countdown-label">Giờ</span></div></div>
        <div class="col-sm-1"><div class="square-box"><p id="minutes" class="countdown-number">00</p><span class="countdown-label">Phút</span></div></div>
        <div class="col-sm-1"><div class="square-box"><p id="seconds" class="countdown-number">00</p><span class="countdown-label">Giây</span></div></div>
    </div>
</div>

<div class="container" id="content">
    <div class="row">
        <div class="col-xl-3 col-lg-4 col-md-5">
            <div class="sidebar-filter mt-0">
                <div class="top-filter-head">Lọc sản phẩm</div>
                <div class="common-filter">
                    <div class="head">Màu sắc</div>
                    <ul>
                        @if (ViewBag.MauList != null)
                        {
                            foreach (SelectListItem mau in ViewBag.MauList)
                            {
                                <li class="filter-list">
                                    <input class="pixel-radio mauInput" type="radio" name="color" style="background-color:@mau.Value" value="@mau.Value">
                                    <label>@mau.Text</label>
                                </li>
                            }
                        }
                    </ul>
                </div>
                <div class="common-filter">
                    <div class="head">Giá</div>
                    <div class="price-range-area">
                        <div id="price-range2"></div>
                        <div class="value-wrapper d-flex">
                            <div class="price">Giá từ:</div><div id="lower-value2"></div><span>₫</span>
                            <div class="to"> - </div><div id="upper-value2"></div><span>₫</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-9 col-lg-8 col-md-7">
            <div class="filter-bar d-flex flex-wrap align-items-center">
                <div class="sorting">
                    @Html.DropDownList("sortGia", new List<SelectListItem>
                    {
                        new SelectListItem { Text = "Sắp xếp giá", Value = "0" },
                        new SelectListItem { Text = "Giá tăng dần", Value = "1" },
                        new SelectListItem { Text = "Giá giảm dần", Value = "2" }
                    }, new { @class = "form-control" })
                </div>
            </div>

            <section class="lattest-product-area pb-40 category-list">
                <div class="row" id="partialSanPhamKm">
                    @{ Html.RenderPartial("_PartialSanPhamTheoLoai", Model); }
                </div>
            </section>
        </div>
    </div>
</div>