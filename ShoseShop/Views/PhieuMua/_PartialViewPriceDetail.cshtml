@using ShoseShop.ViewModel
@model PhieuMuaViewModel

<style>
    /* Custom CSS for Product Slider */
    .product-card_2 {
        position: relative;
        flex: 0 0 auto;
        height: 100px;
    }

    #productSlider_2:hover {
        scrollbar-width: auto;
    }

    /* Hide scrollbar */
    #productSlider_2 {
        overflow-x: hidden;
        overflow-y: auto;
        scrollbar-width: none;
    }

    .voucher-details {
        border: solid 1px #ccc;
        padding: 10px;
        color: black;
        transition: background-color 0.3s;
        border-radius: 20px;
    }

        .voucher-details:hover {
            background-color: black;
            color: white;
        }

            .voucher-details:hover h3 {
                color: white;
            }
</style>

<script>
    var coinAmountChoose = null;
    var coinAmountApply = '@(ViewBag.AmountApply ?? 0)';
    var voucherCode = '@(Model.Choosenvoucher != null ? Model.Choosenvoucher.MaVoucher : "")';
    var applyView = false;
    var boolCheck = '@ViewBag.BoolCheck';
    var changeAmountCode = null;
    var strongFirstPrice = '@Model.totalCost.ToString("#,##0")' + "₫";
    $('#strongFirstPrice').text(strongFirstPrice);
    $('#coinApplyInput').val(coinAmountApply);

    $(document).ready(function () {
        if (boolCheck != "" && boolCheck != "False") {
            $('#checkUseCoin').prop('checked', true);
            $('#useKarCoin').removeAttr('hidden');
            boolCheck = true;
        }
        $('#checkUseCoin').change(function () {
            if ($(this).prop('checked') == true) {
                $('#useKarCoin').removeAttr('hidden');
                boolCheck = true;
            }
            else {
                $('#useKarCoin').attr('hidden', true);
                boolCheck = false;
                $.ajax({
                    url: '/PhieuMua/ChooseVoucherAndApplyXu',
                    type: 'Get',
                    data: {
                        Boolcheck: false,
                        mavoucher: voucherCode,
                        AmountXu: 0,
                        changeAmount: 0,
                        AmountApply: 0,
                        Apply: false,
                    },
                    success: function (response) {
                        $('#partialPriceDetail').html(response);
                    }
                });
            }
        });

        $('#decreaseCoin').click(function () {
            coinAmountChoose = $('#coinInputHidden').val();
            changeAmountCode = 2;
            applyView = false;
            changePriceCoin();
        });

        $('#increaseCoin').click(function () {
            coinAmountChoose = $('#coinInputHidden').val();
            changeAmountCode = 1;
            applyView = false;
            changePriceCoin();
        });

        $('#applyCoin').click(function () {
            coinAmountChoose = $('#coinInputHidden').val();
            applyView = true;
            changePriceCoin();
        });

    });

    if ('@ViewBag.voucherError' != "") {
        alert("@Html.Raw(ViewBag.voucherError)");
        $('#voucherInput').val("");
        voucherCode = null;
    }
    if ('@ViewBag.voucherCode' != "") {
        var mavoucher = '@ViewBag.voucherCode';
        $('#voucherInput').val(mavoucher);
        voucherCode = mavoucher;
    }

    if ('@ViewBag.voucherDiscount' != "") {
        var discountDown = "-" + '@ViewBag.voucherDiscount != null ? ViewBag.voucherDiscount.ToString("#,##0") : ""' + "₫";
        $('#discountSpan').text(discountDown);
        var coinGet = '@Model.coinGet.ToString("#,##0")' + " Karma Coin";
        $('#coinWelcomeNum').text(coinGet);
    }

    if ('@ViewBag.xuTemp' != "" || '@ViewBag.xuTemp' != "0") {
        var coinHiden = '@ViewBag.xuTemp';
        $('#coinInputHidden').val(coinHiden);
    }

    function changePriceCoin() {
        $.ajax({
            url: '/PhieuMua/ChooseVoucherAndApplyXu',
            type: 'Get',
            data: {
                Boolcheck: true,
                mavoucher: voucherCode,
                AmountXu: coinAmountChoose,
                changeAmount: changeAmountCode,
                AmountApply: coinAmountApply,
                Apply: applyView,
            },
            success: function (response) {
                $('#partialPriceDetail').html(response);
            }
        });
    }

    function chooseVoucherDiv(mavoucherView) {
        coinAmountChoose = $('#coinInputHidden').val();
        $.ajax({
            url: '/PhieuMua/ChooseVoucherAndApplyXu',
            type: 'Get',
            data: {
                Boolcheck: boolCheck,
                mavoucher: mavoucherView,
                AmountXu: coinAmountChoose,
                changeAmount: 0,
                AmountApply: coinAmountApply,
                Apply: false
            },
            success: function (response) {
                $('#partialPriceDetail').html(response);
            }
        });
    }

    function chooseVoucherButton() {
        coinAmountChoose = $('#coinInputHidden').val();
        var mavoucherView = $('#voucherInput').val();
        $.ajax({
            url: '/PhieuMua/ChooseVoucherAndApplyXu',
            type: 'Get',
            data: {
                Boolcheck: boolCheck,
                mavoucher: mavoucherView,
                AmountXu: coinAmountChoose,
                changeAmount: 0,
                AmountApply: coinAmountApply,
                Apply: false
            },
            success: function (response) {
                $('#partialPriceDetail').html(response);
            }
        });
    }
</script>

<div id="partialPriceDetail">
    <section class="container position-relative mt-2 mb-2">
        <div id="productSlider_2" class="row flex-row flex-nowrap overflow-auto" style="border-top: solid 1px #ccc;padding-top:15px">
            @foreach (ShoseShop.Data.Voucher voucher in Model.voucherList)
            {
                <div class="product-card_2" style="cursor:pointer" onclick="chooseVoucherDiv('@voucher.MaVoucher')">
                    <div class="voucher-details">
                        <h3 style="padding-bottom:0px;margin-bottom:0px;border:none">
                            @voucher.MaVoucher
                            <span style="font-size:14px;font-weight:normal;">
                                (Available: @voucher.SoLuong)
                            </span>
                        </h3>
                        <p style="margin-bottom:0px">Khuyến mãi @voucher.GiaToiThieu.ToString("#,##0")₫</p>
                        <p style="margin-bottom:0px">Đơn hàng từ @voucher.GiaToiThieu.ToString("#,##0")₫</p>
                    </div>
                </div>
            }
        </div>
    </section>

    <div class="input-group mb-3">
        @Html.TextBoxFor(m => m.Choosenvoucher.MaVoucher, new { @class = "form-control", id = "voucherInput", placeholder = "Mã giảm giá" })
        <div class="input-group-append">
            <button class="btn btn-outline-primary" type="button" onclick="chooseVoucherButton()">Đăng ký</button>
        </div>
    </div>

    @if (Model.khInfo != null)
    {
        <div class="form-check" style="border-top:solid 1px #ccc;padding-top:15px">
            <input class="form-check-input" type="checkbox" value="0" id="checkUseCoin">
            <label class="form-check-label" style="color:#000000">
                <strong>Sử dụng Shoes xu</strong>
                <span style="font-size:12px">
                    (Xu bạn có: @(Model.khInfo != null ? Model.khInfo.TongXu.ToString("#,##0") : ""))
                </span>
            </label>
        </div>

        <div class="input-group mb-3 mt-3" id="useKarCoin" hidden>
            <div style="display:flex; align-items:center;" class="mr-2">
                <a class="btn btn-light btn-sm mr-1" id="decreaseCoin">
                    <i class="bi bi-dash" style="font-size:20px"></i>
                </a>
                @Html.HiddenFor(m => m.coinChoosen, new { id = "coinInputHidden" })
                <input disabled type="text" maxlength="8" value="@Model.coinChoosen.ToString("#,##0")" id="coinInputShow"
                       style="width:241px;text-align:center;">
                <a class="btn btn-light btn-sm ml-1" id="increaseCoin">
                    <i class="bi bi-plus" style="font-size:20px"></i>
                </a>
            </div>
            <div class="input-group-append">
                <button class="btn btn-outline-primary" type="button" id="applyCoin">Đăng ký</button>
            </div>
        </div>
    }

    @Html.HiddenFor(m => m.coinApply, new { id = "coinApplyInput" })
    @Html.HiddenFor(m => m.tempCost)
    @Html.HiddenFor(m => m.totalCost)
    @Html.HiddenFor(m => m.coinGet)
    @Html.HiddenFor(m => m.discountMoney)

    <ul class="list list_2 mt-3" style="border-top:solid 1px #ccc;padding-top:5px">
        <li><a style="border:none;font-size:12px">Tạm tính<span style="color:#231f20">@Model.tempCost.ToString("#,##0")₫</span></a></li>
        <li><a style="border:none;font-size:12px">Khấu trừ<span style="color:#231f20" id="discountSpan">-@Model.discountMoney.ToString("#,##0")₫</span></a></li>
        <li><a style="border:none;font-size:12px">Phí vận chuyển<span style="color:#231f20">Miễn phí</span></a></li>
        <li style="border-top:solid 1px #ccc;padding-top:15px">
            <a style="border-bottom:none;">
                Tổng hóa đơn<span style="font-size:20.8px;font-weight:bold;color:#231f20">
                    @Model.totalCost.ToString("#,##0")₫
                </span>
            </a>
        </li>
        <li style="border-top:solid 1px #ccc;">
            <a style="border:none;font-size:12px">
                Lấy xu
                <span style="color:#2F5ACF">
                    +@Model.coinGet.ToString("#,##0")
                </span>
            </a>
        </li>
    </ul>
</div>
