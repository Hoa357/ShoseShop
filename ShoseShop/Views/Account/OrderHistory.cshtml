@model List<ShoseShop.Data.PhieuMua>

<h3 style="text-align: center;">Danh sách giao hàng</h3>
@if (Model != null && Model.Any())
{
    <table class="table table-striped" style="text-align: center;">
        <thead>
            <tr>
                <th>Mã đơn hàng</th>
                <th>Ngày đặt</th>
                <th>Trạng thái</th>
                <th>Đồng xu áp dụng</th>
                <th>Tiền xu nhận được</th>
                <th>Tổng số tiền</th>
                <th>Hoạt động</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var order in Model)
            {
           
                var tongtien = order.ChiTietPhieuMuas?.Sum(x => (decimal?)(x.SoLuong * x.DonGia)) ?? 0;

               
                var voucherDiscount = order.MaVoucherNavigation?.GiaToiDa ?? 0;
                var coinApply = (tongtien - order.TongTien - voucherDiscount) > 0 ? (tongtien - order.TongTien - voucherDiscount) : 0;

                var coinGet = Math.Ceiling(order.TongTien / 100000m) * 1000;

                <tr>
                    <td>@order.MaPhieuMua</td>
                    <td>@order.NgayMua.ToString("dd/MM/yyyy")</td>
                    <td>
                     
                        @{ Html.RenderPartial("_OrderStatus", order.TinhTrang); }
                    </td>
                    <td>
                        -@coinApply?.ToString("#,##0")
                        <strong style="color:#2F5ACF" class="ml-1"><i class="bi bi-coin"></i></strong>
                    </td>
                    <td>
                        +@coinGet.ToString("#,##0")
                        <strong style="color:#2F5ACF" class="ml-1"><i class="bi bi-coin"></i></strong>
                    </td>
                    <td>@order.TongTien?.ToString("C0", new System.Globalization.CultureInfo("vi-VN"))</td>
                    <td>
                        <button type="button" class="genric-btn info radius" data-toggle="modal" data-target="#modal_@order.MaPhieuMua">
                            Chi tiết
                        </button>

                        <!-- Modal -->
                        <div class="modal fade" id="modal_@order.MaPhieuMua" tabindex="-1" role="dialog" aria-labelledby="modalLabel_@order.MaPhieuMua" aria-hidden="true">
                            <div class="modal-dialog" role="document" style="max-width:60%">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title mr-1" id="modalLabel_@order.MaPhieuMua">Chi tiết đơn hàng</h5>
                                        @{ Html.RenderPartial("_OrderStatus", order.TinhTrang); }
                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                            <span aria-hidden="true">&times;</span>
                                        </button>
                                    </div>
                                    <div class="modal-body">
                                        <h4>Mã đơn hàng: @order.MaPhieuMua</h4>
                                        <div>
                                            <div class="row">
                                                <div class="col-6" style="text-align:left">
                                                    <p>Ngày đặt: @order.NgayMua.ToString("dd/MM/yyyy HH:mm")</p>
                                                </div>
                                                <div class="col-6 d-flex justify-content-end">
                                                    <p>Tổng số tiền: @order.TongTien?.ToString("C0", new System.Globalization.CultureInfo("vi-VN"))</p>
                                                </div>
                                            </div>
                                            <div class="order-details-grid" style="text-align:left">
                                                <div>Tên người nhận:</div><div>@order.TenNguoiNhan</div>
                                                <div>Số điện thoại:</div><div>@order.SoDienThoaiNguoiNhan</div>
                                                <div>Địa chỉ người nhận:</div><div>@order.DiaChiNguoiNhan</div>
                                                <div>Ghi chú:</div><div>@(order.GhiChu ?? "Không có ghi chú")</div>
                                            </div>

                                            <table class="table table-striped">
                                                <thead>
                                                    <tr>
                                                        <th>Tên sản phẩm</th>
                                                        <th>Hình ảnh</th>
                                                        <th>Số lượng</th>
                                                        <th>Kích thước</th>
                                                        <th>Màu sắc</th>
                                                        <th>Đơn giá</th>
                                                        <th>Tổng giá</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @if (order.ChiTietPhieuMuas != null)
                                                    {
                                                        foreach (var item in order.ChiTietPhieuMuas)
                                                        {
                                                           
                                                            var tenSanPham = item.MaSPSizeNavigation?.MaSPCTNavigation?.MaSPNavigation?.TenSanPham ?? "N/A";
                                                            var duongDanAnh = (item.MaSPSizeNavigation?.MaSPCTNavigation?.MaSPNavigation != null)
                                                                ? Url.Content("~/img/" + item.MaSPSizeNavigation.MaSPCTNavigation.MaSPNavigation.MaSanPham + "/" + item.MaSPSizeNavigation.MaSPCTNavigation.AnhDaiDien)
                                                                : Url.Content("~/img/placeholder.png"); // Ảnh mặc định nếu có lỗi
                                                            var tenSize = item.MaSPSizeNavigation?.MaSizeNavigation?.TenSize ?? "N/A";
                                                            var tenMau = item.MaSPSizeNavigation?.MaSPCTNavigation?.MaMauNavigation?.TenMau ?? "N/A";
                                                            var totalPrice = item.SoLuong * item.DonGia;

                                                            <tr>
                                                                <td>@tenSanPham</td>
                                                                <td><img src="@duongDanAnh" style="width:60px;height:60px;border-radius:3px;" /></td>
                                                                <td>@item.SoLuong</td>
                                                                <td>@tenSize</td>
                                                                <td>@tenMau</td>
                                                                <td>@item.DonGia.ToString("C0", new System.Globalization.CultureInfo("vi-VN"))</td>
                                                                <td>@totalPrice?.ToString("C0", new System.Globalization.CultureInfo("vi-VN"))</td>
                                                            </tr>
                                                        }
                                                    }
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="genric-btn default radius" data-dismiss="modal">Đóng</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}
else
{
    <p>Bạn chưa có đơn hàng nào hết</p>
}

<style>
    .order-details-grid {
        display: grid;
        grid-template-columns: auto 1fr;
        gap: 10px 20px;
    }

        .order-details-grid div {
            padding: 5px 0;
        }
</style>